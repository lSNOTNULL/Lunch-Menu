<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <!-- 3ë‹¨ê³„ : LLM APIë¥¼ ì¨ì„œ ì‘ì„± ë°ì´í„°ì— ëŒ€í•œ ì¶”ì²œì„ ìƒì„±í•˜ê³ , secure coding ì²˜ë¦¬ -->
    <header>
      <button id="resetButton">ì €ì¥ëœ ë°ì´í„° ë¦¬ì…‹</button>
    </header>
    <form id="controller">
      <label>
        ëª¨ë¸ :
        <select name="modelOption">
          <option value="1">gemini-1.5-flash</option>
          <option value="2">deepseek-r1</option>
        </select>
      </label>
      <textarea name="textData"></textarea>
      <button>ë“±ë¡</button>
    </form>
    <div id="container"></div>
    <script>
      const container = document.querySelector("#container");
      const form = document.querySelector("#controller");
      const resetButton = document.querySelector("#resetButton");
      resetButton.addEventListener("click", () => (data.length = 0));
      const data = new Proxy([], {
        set(target, property, value) {
          target[property] = value;
          updateContainer();
          updateStorage(target);
          return true;
        },
      });
      function onMounted() {
        data.push(...(JSON.parse(localStorage.getItem("myData")) ?? []));
      }
      onMounted();

      function updateContainer() {
        container.innerHTML = "";
        for (const d of data) {
          const tmp = document.createElement("div");
          tmp.textContent = d.text;
          const deleteButton = document.createElement("button");
          deleteButton.textContent = "ì‚­ì œ";
          deleteButton.addEventListener("click", () => {
            const fillterd = data.filter((value) => value.id !== d.id);
            data.length = 0;
            data.push(...fillterd);
          });
          // LLM ì‘ë‹µ
          if (d.reply) {
            const box = document.createElement("div");
            const reply = document.createElement("code");
            box.appendChild(reply);
            // CSS in JS, Styled Component
            box.style.padding = "12px";
            box.style.margin = "4px";
            box.style.backgroundColor = "beige";
            box.style.border = "1px solid black";
            reply.textContent = d.reply;
            tmp.appendChild(box);
          }
          tmp.appendChild(deleteButton);
          container.appendChild(tmp);
        }
      }

      function updateStorage(target) {
        // console.log(target);
        localStorage.setItem("myData", JSON.stringify(target));
        // console.log(localStorage.getItem("myData"));
      }
      async function handleForm(event) {
        // awaitë¥¼ ì“°ë ¤ë©´ asyncë¡œ ê°ì‹¸ì ¸ì•„í•¨
        event.preventDefault();
        const formData = new FormData(form);
        // ì´ì¯¤ì—ì„œ ê·¸ëƒ¥ ì¶”ì²œ ë°›ìœ¼ë©´ ì¢‹ì§€ ì•Šì„ê¹Œ?
        const text = formData.get("textData");
        let reply;
        switch (formData.get("modelOption")) {
          case "1":
            reply = `ğŸ‘¬ Gemini : ${await makeReply(text)}`;
            break;
          case "2":
            reply = `ğŸ‘€ DeepSeek : ${await makeReply2(text)}`;
            break;
          default:
            alert("ë¹„ì •ìƒì ì¸ ì ‘ê·¼!");
            throw new Error("ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬!");
            break;
        }
        // const reply = await makeReply(text); // ë„¤íŠ¸ì›Œí¬? ë°ì´í„° í†µì‹ ?
        // const reply = await makeReply2(text); // ëª¨ë¸ êµì²´
        const displayData = {
          id: Date.now(),
          text,
          reply, // ë‹¨ì¶• ë¬¸ë²• ì¤‘ í•˜ë‚˜ (property = keyì˜ ì´ë¦„ê³¼ valueì— ë“¤ì–´ê°€ëŠ” ë³€ìˆ˜ëª…ì´ ê°™ìœ¼ë©´ ë‹¨ì¶• ê°€ëŠ¥)
        };
        data.push(displayData);
      }
      // 1ì°¨ gemini
      async function makeReply(text) {
        // https://aistudio.google.com/
        const GEMINI_API_KEY = "AIzaSyDaUBypQPdvPUuQrqqd3qelIQcqtYc6Zto";
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const response = await fetch(url, {
          method: "POST", // ì†Œì¤‘í•œ í¸ì§€ë¥¼ í’ˆì— ì•ˆê³  ê°€ëŠ” ê²ƒ.
          // fetchëŠ” ë‹¨ìˆœí•œ íˆ´ì´ë¼ì„œ ì§ë ¬í™”ë¥¼ í•´ì¤˜ì•¼í•¨
          body: JSON.stringify({
            contents: [
              {
                parts: [
                  {
                    text: `ë„ˆëŠ” 20ë…„ ê²½ë ¥ì˜ ë©”ë‰´ ì¶”ì²œ ì „ë¬¸ê°€ì•¼. {${text}}ì˜ ë©”ì‹œì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì ì‹¬ ë©”ë‰´ë¥¼ ì¶”ì²œí•´ì£¼ê³ , 50ì ì´ë‚´ì— í‰ë¬¸ìœ¼ë¡œ ì‘ì„±í•´ì¤˜.`,
                  },
                ], // ìƒëµí•  ìˆ˜ ìˆë‹¤ -> í”„ë¡œí¼í‹° ì´ë¦„ê³¼ ë°¸ë¥˜ ë³€ìˆ˜ì´ë¦„ì´ ê°™ìœ¼ë©´...
              },
            ],
          }),
          headers: {
            "Content-Type": "application/json", // JSON ì‘ë‹µì„ ì£¼ì„¸ìš”
          },
        });
        const json = await response.json(); // JSON.parse
        // console.log(json);
        // return JSON.stringify(json);
        return json.candidates[0].content.parts[0].text;
      }
      // 2ì°¨ deepseek
      async function makeReply2(
        content,
        model = "deepseek-r1-distill-llama-70b"
      ) {
        // deepseek-r1-distill-llama-70b
        /*
          curl -X POST "https://api.groq.com/openai/v1/chat/completions" \
              -H "Authorization: Bearer $GROQ_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{"messages": [{"role": "user", "content": "Explain the importance of fast language models"}], "model": "llama-3.3-70b-versatile"}'
          */
        const GROQ_API_KEY =
          "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";
        const url = "https://api.groq.com/openai/v1/chat/completions";
        const response = await fetch(url, {
          method: "POST", // ì†Œì¤‘í•œ í¸ì§€ë¥¼ í’ˆì— ì•ˆê³  ê°€ëŠ” ê²ƒ.
          // fetchëŠ” ë‹¨ìˆœí•œ íˆ´ì´ë¼ì„œ ì§ë ¬í™”ë¥¼ í•´ì¤˜ì•¼í•¨
          body: JSON.stringify({
            messages: [
              {
                role: "user",
                content: `ë„ˆëŠ” 20ë…„ ê²½ë ¥ì˜ ë©”ë‰´ ì¶”ì²œ ì „ë¬¸ê°€ì•¼. {${content}}ì˜ ë©”ì‹œì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì ì‹¬ ë©”ë‰´ë¥¼ ì¶”ì²œí•´ì£¼ê³ , 50ì ì´ë‚´ì— í‰ë¬¸ìœ¼ë¡œ ì‘ì„±í•´ì¤˜. ê²°ê³¼ëŠ” í•œê¸€ë¡œ ì‘ì„±í•´ì¤˜.`, // ë‹¨ì¶•ì„ ìœ„í•´ì„œ ê°ê°ì˜ apiê°€ í˜•íƒœì— ë§ì¶°ì„œ
                // ë³€ìˆ˜ëª…ì´ë‚˜ íŒ¨ëŸ¬ë¯¸í„° ëª…ì„ ë°”ê¾¸ëŠ” ê²ƒë„...
              },
            ],
            model,
          }),
          headers: {
            Authorization: `Bearer ${GROQ_API_KEY}`,
            "Content-Type": "application/json", // JSON ì‘ë‹µì„ ì£¼ì„¸ìš”
          },
        });
        const json = await response.json(); // JSON.parse
        // console.log(json);
        // return JSON.stringify(json);
        // return json.choices[0].message.content;
        // split -> íŠ¹ì •í•œ ë¬¸ìíŒ¨í„´ì„ ê¸°ì¤€ìœ¼ë¡œ ë°°ì—´ì„ ë§Œë“¤ì–´ í† í°(ê°œë³„ ì›ì†Œ)í™”
        return json.choices[0].message.content.split("</think>")[1].trim(); // ì•ë’¤ì— ê³µë°±ì„ ì˜ë¼ì¤Œ.
      }
      form.addEventListener("submit", handleForm);
    </script>
  </body>
</html>
